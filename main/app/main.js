"use strict";const e=require("electron"),a=require("path"),d=require("process"),g=require("./autoUpdate.js");require("events");require("crypto");require("tty");require("util");require("os");require("fs");require("stream");require("url");require("string_decoder");require("constants");require("assert");require("child_process");require("zlib");require("http");global.shareObject={};let o,r,l=!1;const c=()=>{if(r)return;const i={show:!1,hasShadow:!0,useContentSize:!1,resizable:!0,center:!0,maximizable:!1,backgroundColor:"#fff",webPreferences:{webSecurity:!1,nodeIntegration:!0,preload:a.join(__dirname,"./preload.js")}},n={height:545,width:470,autoHideMenuBar:!0},s={height:500,width:450,frame:!1,transparent:!0,titleBarStyle:"hidden"},t=d.platform==="darwin"?{...i,...s}:{...i,...n};r=new e.BrowserWindow(t),process.env.NODE_ENV==="development"?r.loadURL(`${process.env.VITE_DEV_SERVER_URL}#/login`):r.loadFile(a.join(__dirname,"FitsAdmin/index.html"),{hash:"login"}),r.once("ready-to-show",()=>{r.show()}),r.on("closed",()=>{r=null})},w=()=>{o||(o=new e.BrowserWindow({show:!1,icon:a.join(__dirname,"./resources/icons/icon.ico"),width:1366,height:768,minWidth:900,minHeight:600,autoHideMenuBar:!0,useContentSize:!0,webPreferences:{webSecurity:!1,nodeIntegration:!0,preload:a.join(__dirname,"./preload.js")}}),o.webContents.openDevTools(),process.env.NODE_ENV==="development"?o.loadURL(`${d.env.VITE_DEV_SERVER_URL}#/home`):o.loadFile(a.join(__dirname,"FitsAdmin/index.html"),{hash:"Home"}),o.on("closed",()=>{o=null}),o.once("ready-to-show",()=>{o.show()}),o.on("will-resize",(i,n)=>{m({width:n.width},o.webContents)}),l&&g.autoUpdate(o))},p=e.app.requestSingleInstanceLock();console.log("当前有个多少个实例",p);p?e.app.on("second-instance",(i,n,s)=>{console.log("第二个实例");const t=o||r;t&&t.focus}):e.app.quit();e.app.whenReady().then(()=>{console.log("我执行了没"),c(),d.platform==="darwin"&&e.Menu.setApplicationMenu(e.Menu.buildFromTemplate([]))});e.app.on("activate",()=>{e.BrowserWindow.getAllWindows().length===0&&(l?w():c())});e.app.on("window-all-closed",()=>{console.log("window-all-closed"),process.platform!=="darwin"&&e.app.quit()});e.ipcMain.on("openMainWindow",()=>{l=!0,w(),console.log("openMainWindow"),r.destroy(),r=null});e.ipcMain.on("openLoginWindow",()=>{l=!1,c(),o.destroy(),o=null});e.ipcMain.on("firstWidowResize",(i,{width:n})=>{m({width:n},i.sender)});function m({width:i},n){if(!l)return;const s=1920,t=e.screen.getPrimaryDisplay().scaleFactor,u=Math.min(Math.max(Number(i/s*t),.9),1.2).toFixed(3);n.send("setZoomFactor",u)}e.ipcMain.on("openWinFormWindow",(i,{methodName:n,params:s})=>{process.platform==="win32"?require("electron-edge-js").func({assemblyFile:a.join(__dirname,"../resources/dll/FitsTest.dll"),typeName:"FitsTest.Test",methodName:n})(s,(h,f)=>{i.sender.send("handleWinFormWindow",{error:h,value:f})}):e.dialog.showMessageBox({title:"温馨提示",message:"打开dll文件只能在window环境才会生效",type:"error",buttons:["确定"]})});e.ipcMain.on("setCookies",(i,{url:n,name:s,value:t})=>{e.session.defaultSession.cookies.set({url:n,name:s,value:t})});e.ipcMain.on("getCookies",(i,{url:n,name:s})=>{e.session.defaultSession.cookies.get({url:n,name:s})});
