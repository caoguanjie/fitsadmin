<template>
    <div>
        <vxe-grid ref="xGrid" v-bind="gridOptions" />
    </div>
    <!-- <fits-table :option="fitsTablePro" ref="xGrid" v-bind="gridOptions" /> -->
</template>
<script lang="ts">
export default {
    name: 'TestView'
}
</script>
<script lang="ts" setup>
import { FitsTable } from '@/fits-components';
import { FitsTableProps, useFitsTablePro } from '@/fits-components/type'
import { ref, reactive } from 'vue'
import { VxeGridInstance, VxeTableDefines, VxeGridPropTypes, VxeGridProps } from 'vxe-table'

interface RowVO {
    [key: string]: any
}

let xGrid = ref<VxeGridInstance | any>()

const footerData = ref<string[][]>([])

const gridOptions = reactive<VxeGridProps<RowVO>>({
    // keepSource: false,
    // border: true,
    // showOverflow: true,
    // showHeaderOverflow: true,
    // showFooterOverflow: true,
    // showFooter: true,
    // height: 500,
    // loading: false,
    // rowConfig: {
    //     keyField: 'id'
    // },
    // checkboxConfig: {
    //     checkField: 'checked',
    //     labelField: 'id'
    // },
    // footerMethod() {
    //     return footerData.value
    // }
})
const { fitsTablePro } = useFitsTablePro(gridOptions, xGrid)
let colIndex = 0
let rowIndex = 1

const findColumnList = (size: number) => {
    return new Promise<VxeGridPropTypes.Columns>(resolve => {
        setTimeout(() => {
            const columns: VxeGridPropTypes.Columns = []
            for (let index = 0; index < size; index++) {
                const key = colIndex++
                const config: VxeTableDefines.ColumnOptions = {
                    field: key ? `col_${key}` : 'id',
                    title: key ? `标题_${key}` : 'ID',
                    width: 140,
                    type: null,
                    fixed: null
                }
                if (!key) {
                    config.type = 'checkbox'
                }
                if (key < 2) {
                    config.fixed = 'left'
                }
                columns.push(config)
            }
            resolve(columns)
        }, 250)
    })
}

const findDataList = (size: number) => {
    return new Promise<any[]>(resolve => {
        setTimeout(() => {
            const list: any[] = []
            for (let index = 0; index < size; index++) {
                const key = rowIndex++
                const item: any = { id: key, checked: false }
                // 由于生成数据比较耗时，所以固定生成1000字段
                Array.from(new Array(1000)).forEach((num, cIndex) => {
                    item[`col_${cIndex}`] = `内容_${cIndex}_${index}`
                })
                list.push(item)
            }
            resolve(list)
        }, 250)
    })
}

const init = async () => {
    let tableColumn: VxeGridPropTypes.Columns = []
    gridOptions.loading = true
    await Promise.all([
        findColumnList(200).then(columns => {
            let $grid = xGrid.value.fitsTablePro
            if ($grid) {
                tableColumn = columns
                $grid.loadColumn(columns)
                $grid = null
            }
        }),
        findDataList(600).then(data => {
            let $grid = xGrid.value.fitsTablePro
            if ($grid) {
                $grid.loadData(data)
                $grid = null
            }
        })
    ])

    let $grid = xGrid.value.fitsTablePro
    gridOptions.loading = false

    // 计算表尾数据 
    const footList: string[][] = [[]]
    tableColumn.forEach((column, index) => {
        footList[0].push(index === 0 ? '合计' : `${index}`)
    })
    footerData.value = footList
    if ($grid) {
        $grid.updateFooter()
        $grid = null
    }
}

// init()

// onUnmounted(() => {
//     console.log('页面销毁')
//     xGrid.value = null
// })
</script>
  